---
layout: post
title:  "STM32中Timer定时器使用(1)"
date:   2019-3-2 10:11:00
categories: STM32
tags: STM32 C 嵌入式
excerpt: STM32中TImer定时器功能使用详解
mathjax: true
---

咕了一万年= =，继续吧STM32的博客写一下。 
   
这次说一下TIM定时器。  
首先看一下stm32官方手册对于TIM定时器的介绍：  
  1.TIM定时器分两类：1)`TIM1、TIM8高级控制定时器`
                    2)`通用TIMx (TIM2、 TIM3、 TIM4和TIM5)定时器`
                    3)`基本定时器(TIM6和TIM7)`  
    
  
基本定时器TIM6与TIM7纯粹做定时用，可以触发定时中断，  
通用定时器与高级定时器则可以完成其他操作，像输入捕获、输出比较、PWM波生成等  
  
因此，此处只介绍通用定时器的功能：  
定时器的寄存器较多，此处不一一介绍其功能。  
#时基单元  
TIM主要部分是一个16位计数器和与其相关的自动装载寄存器组成，计数器可以向上计数，向下计数，或双向计数。计数器、自动装载寄存器和预分频器寄存器可以由软件读写，在计数器运行时仍可以读写。  
时基单元包含：  
+ 计数器寄存器（`TIMx_CNT`）
+ 预分频器寄存器（`TIMx_PSC`）
+ 自动装载寄存器（`TIMx_ARR`）
  
自动装载寄存器是预先装载的，写或读自动重装载寄存器将访问预装载寄存器。  
  
之前对于时钟分频因子（即`TIMx_PSC`寄存器的值），自动装载寄存器（`TIMx_ARR`）寄存器不是很理解，后来仔细阅读f103的数据手册后有了一定理解：  
  
1.查询F103时钟树可知，非高级定时器（TIM2-7）的时钟信号`TIMxCLK`是来自于挂载在APB1总线上的一个倍频器，且如果APB1预分频系数为1，则频率不变，否则频率*2。  
在经过`SystemInit()`函数初始化之后，`AHB`总线时钟等于`SYSCLK`(72MHz),`APB1`总线频率不能超过36MHZ，所以默认是2分频，即36MHz。  
由于`APB1`预分频系数为2，故倍频器使能，输出72MHz的时钟信号作为`TIMxCLK`。
  
2.`TIMx_PSC`寄存器中的数值（一个16位数）加一后决定了对`TIMxCLK`进行几分频作为定时器时钟`CK_CNT`的值。  
例如：当`TIMx_PSC`中的值为0x0001时，将`TIMxCLK`2分频，即36MHz作为定时器时钟，则每1/36M秒计数器寄存器的值加一。  
  
3.当`TIMx_CNT`中的值达到`TIMx_ARR`的值时(这一周期结束时)，计数器溢出，产生更新事件，`TIMx_CNT`中的值被重置到0，同时更新中断标志`UIF`,如果使能了溢出中断，则会由中断向量表跳转至TIM的中断服务函数。  
  
4.计算一次更新事件的时间：  
$T = \frac {SYSCLK*(TIMxARR+1)}{TIMx_PSC+1}$  
至于为什么要+1的问题，首先，PSC寄存器是由于定义的问题，由于16位数能表示的实际范围为0-65535,但0不能作为分母，分频无意义，故将psc+1，使其表示1-65536。  
而ARR寄存器是由于在计数器寄存器加到等于ARR寄存器时，需要等待这一定时器时钟周期结束时才产生计数器溢出，更新事件。  
例如：ARR寄存器值为2，计数器从0开始向上计数，一个周期后CNT变为1，两个周期后CNT变为2，但并不是变为2的开始时就产生溢出，而是在这一周期结束瞬间才产生溢出（即在即将变为3时，考虑`溢出`一词的含义），也就是三个周期了。